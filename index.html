<!DOCTYPE HTML>
<html>
    <head>
        <meta charset="UTF-8">
        <title>FinnCam</title>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css">
	<link rel="stylesheet" href={{ static_url("custom.css") }}>
    </head>
    <body>
    <div class="container">
        <div class="header">
          <h3 class="text-muted">FinnCam</h3>
          
          <fieldset style="width: 100%;">
            <legend>Licht Control panel</legend>
            <button onclick=sendCmd("/irledon")>IR An</button>
            <button onclick=sendCmd("/irledoff")>IR Aus</button>
            <span>&nbsp;&nbsp;</span>
            <button onclick=sendCmd("/ledon")>LED An</button>
            <button onclick=sendCmd("/ledoff")>LED Aus</button>
          </fieldset>
          <br />
          <label>IR status: </label><span id="state_line_ir"/></span>
          <label>LED status: </label><span id="state_line_normal"/></span>
          <fieldset style="width: 100%;">
            <legend>Drehen Control panel</legend>
            <button onclick=sendCmd("/servoplusccw")>+CCW</button>
            <button onclick=sendCmd("/servoccw")>CCW</button>
            <button onclick=sendCmd("/servooff")>Aus</button>
            <button onclick=sendCmd("/servocw")>CW</button>
            <button onclick=sendCmd("/servopluscw")>+CW</button>
          </fieldset>
          <br />
          <label>Drehen status: </label><span id="state_line_servo"/></span>
        </div>
	<div class="jumbotron" id="motion-image">
	  <img id="motion_image" />
	</div>
  
  <!-- current status -->
        <div class="jumbotron">
            <h1 class="time_stamp" id="quiet"><span id="time_quiet"></span></h1>
            <h1 class="time_stamp" id="crying"><span id="time_crying"></span></h1>
        </div>

        <!-- scrolling volume plot -->
        <div class="plot-container">
			<div id="plot" class="plot-placeholder"></div>
		</div>

        <!-- history -->
        <table class="table table-hover" id="history_table">
        </table>
    </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/js/bootstrap.min.js"></script>
    <script language="javascript" type="text/javascript" src={{ static_url("jquery.flot.js") }}></script>

    
    <script type="text/javascript">
      function sendCmd(cmd) {
          $.ajax({
              url: cmd,
              success: function( data ) {
                  $("#state_line").text(data);
              },
              error: function () {
                 $("#state_line").text("Error");
              }
          }); 
      }
      document.getElementById("motion_image").src =
      "http://" + window.location.hostname + ":8081" ;
      
      $(function() {
        var zeros = []
        for (var i = 0; i < 3600; i++) { zeros.push([i, 0.0]); }
        var plot = $.plot("#plot", [ zeros ], {
            series: {
                color: "#000",
                shadowSize: 0,	// Drawing is faster without shadows
                lines: {
                    lineWidth: 2
                }
            },
            yaxis: {
                min: 0.0,
                max: 1.0,
                show: false
            },
            xaxis: {
                show: false
            },
            grid: {
                borderWidth: 0
            }
        });

        var socket = new WebSocket("ws://" + window.location.hostname + ":8090/ws");

        socket.onmessage = function (message) {
            // update the text display
                            $("#state_line_ir").text(JSON.parse(message.data).irled_status);
                            $("#state_line_normal").text(JSON.parse(message.data).led_status);
			    $("#state_line_servo").text(JSON.parse(message.data).servo_status);
                            $("#time_quiet").text(JSON.parse(message.data).time_quiet);
                            $("#time_crying").text(JSON.parse(message.data).time_crying);
            console.log(JSON.parse(message.data).cur_value);
            // update the history table
            var table = "<tr><th>Finn hat Krach gemacht um</th><th>Dauer</th></tr>";
            $.each(JSON.parse(message.data).crying_blocks, function( index, crying_block ) {
               table += "<tr><td>" + crying_block.start_str + "</td><td>" + crying_block.duration + "</td></tr>";
            });
            $("#history_table").html(table);

            // update the plot of the volume levels for the past hour
            var data = JSON.parse(message.data).audio_plot;
            var vals = [];
			for (var i = 0; i < data.length; i++) { vals.push([i, data[i]]); }
            plot.setData([ vals ]);
            plot.draw();
        };
    });
    </script>

    </body>
</html>
